# ETF轮动策略 - 快速开始指南

## 项目概述

本项目将聚宽平台的ETF轮动策略成功重构为backtrader框架版本，实现了多因子模型选股、动态风控、市场风险判断等核心功能。

### ✅ 已完成功能

1. **多因子模型**
   - 动量因子：基于年化收益和判定系数
   - 质量因子：包含7个子因子（斜率R²、均线、RSRS、波动率、最大回撤、夏普比率、多周期均线）

2. **动态风控系统**
   - 基于市场波动率分位的动态参数调整
   - 成本止损 + 跟踪止损组合
   - 动态止盈机制

3. **市场风险判断**
   - 基于沪深300的均线和波动率分位
   - 高风险/低风险/中性市场三种状态
   - 自动仓位调整（50%/80%/100%）

4. **风格分散配置**
   - 商品、海外、A股、科技四大风格分类
   - 优先选择不同风格ETF分散风险
   - 最多持有3个标的

5. **调仓规则**
   - 每周一自动调仓
   - 权重偏离超5%时触发调仓
   - 基于因子得分的动态权重分配

## 🚀 快速开始

### 1. 安装依赖

```bash
# 使用uv安装所有依赖
uv sync
```

### 2. 验证安装

```bash
# 运行功能演示
uv run python demo.py
```

应该看到所有测试通过的消息。

### 3. 准备数据

#### 步骤1：设置tushare token

1. 访问 [tushare.pro](https://tushare.pro/) 注册账号（免费）
2. 登录后进入"个人中心" -> "接口Token"
3. 复制token并设置环境变量：

```bash
export TUSHARE_TOKEN='你的token'
```

#### 步骤2：下载数据

使用项目内置的数据下载脚本：

```bash
python data_fetcher.py
```

这将自动下载：
- 基准指数数据（沪深300：000300.SH）
- 所有配置的ETF数据

下载的数据保存在 `data/` 目录中，格式为CSV。

### 4. 运行回测

```bash
cd examples
python run_strategy.py
```

## 📊 回测结果解读

回测完成后会显示以下指标：

```
最终资金: 1,234,567.89
总收益: 234,567.89
总收益率: 23.46%

年化收益率: 5.23%
夏普比率: 1.45
最大回撤: -8.76%
回撤时长: 45 天
```

### 指标说明

- **总收益率**：整个回测期间的总回报
- **年化收益率**：平均每年的收益率
- **夏普比率**：风险调整后的收益，越高越好（>1为优秀）
- **最大回撤**：从峰值到谷底的最大跌幅，越小越好（<-20%需警惕）
- **回撤时长**：从峰值到恢复的时间

## ⚙️ 自定义配置

修改 `config/config.yaml` 来调整策略参数：

### 因子参数调整

```yaml
factor_params:
  momentum_window: 25  # 动量窗口，值越大越稳定但反应越慢
  slope_window: 20     # 斜率窗口
  ma_window: 20        # 均线窗口
```

### 风控参数调整

```yaml
risk_params:
  stop_loss_base: 0.05     # 基础止损，值越小止损越频繁
  take_profit_ratio: 0.10  # 基础止盈，值越小止盈越频繁
```

### 交易参数调整

```yaml
trading_params:
  max_holdings: 3          # 最多持有标的数量
  score_threshold: 0       # 因子得分阈值，高于阈值才买入
```

## 🔧 策略优化建议

### 1. 因子参数优化

尝试不同的窗口期组合：

```python
# 更敏感的动量
momentum_window: 15

# 更平滑的质量
slope_window: 30
ma_window: 30
```

### 2. 风控参数优化

更严格的风控：

```python
stop_loss_base: 0.03      # 3%止损
take_profit_ratio: 0.08   # 8%止盈
```

### 3. 选股参数优化

更严格的选股：

```python
score_threshold: 0.1       # 只选得分>0.1的ETF
max_holdings: 2           # 减少到2只提高集中度
```

## ⚠️ 注意事项

1. **数据质量**：确保数据完整，避免缺失值
2. **交易成本**：实际交易中需考虑佣金和滑点
3. **市场环境**：策略在不同市场环境下表现不同
4. **风险控制**：严格执行风控规则，避免情绪化交易

## 📚 扩展阅读

- [backtrader官方文档](https://www.backtrader.com/)
- [量化交易入门](https://www.joinquant.com/)
- [多因子模型介绍](https://zhuanlan.zhihu.com/p/426896463)

## 🆘 常见问题

### Q: tushare token如何获取？
A: 访问 https://tushare.pro/ 注册账号（免费），登录后在"个人中心" -> "接口Token"中获取。每日有免费调用次数限制。

### Q: 数据下载失败？
A:
1. 检查是否正确设置了 `TUSHARE_TOKEN` 环境变量
2. 检查网络连接
3. 确认token是否有效（未过期）
4. 检查tushare调用次数是否超限

### Q: 回测结果不理想？
A: 尝试调整风控参数，或者使用更长的时间周期（至少3年）。

### Q: 如何添加新的ETF？
A: 修改`config/config.yaml`中的`etf_list`部分，添加新的ETF代码和风格分类，然后重新下载数据。

### Q: 如何保存回测结果？
A: 在`run_strategy.py`中添加代码保存Cerebro的绘图结果：
```python
cerebro.plot(style='candlestick')
```

## 📝 更新日志

### v1.0.0 (2024-12-11)
- ✅ 初始版本发布
- ✅ 完成多因子模型实现
- ✅ 完成动态风控系统
- ✅ 完成市场风险判断
- ✅ 完成风格分散配置
- ✅ 完成调仓规则实现
- ✅ 添加单元测试
- ✅ 添加演示脚本

---

**提示**：建议先用模拟数据运行一遍，确认策略逻辑正确后再使用真实数据。
